<!DOCTYPE html>
<html lang="en">
<head>
  <title>Covid News</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  


  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  <script src="line.js"></script>
   <script src="geo.js"></script>
   <script src="pie.js"></script>
	<style>
	body{
	background-color: #000000;
    color : #FFFFFF;
    }
	.tab {
	background-color:#323232;
	}
	.title {
	color :#FF8C00;
	font-size :20px;
	font-weight: bold;
	}
	.date {
	 background-color:#323232;
	 width:200px;
     height:40px;
	 }
	.recovered {
	  
	  background-color:#3CB371;
	 }
	.cases {
	  background-color:#0000CD;
	  }
	.deaths {
	   background-color:#DC143C;
	}
	p {
	  text-align: center;
	}
    #new {
	  text-align: left;
	}
	tbody {
	height:600px;
	overflow:auto;
    }
	.centrer {
     text-align: center;
    }
	.right {
     text-align: right;
    }
	  
	</style>

	
   
<script>
    window.addEventListener('load', () => {
        let j = 2
        var form = document.getElementById('formulaire')
        form.addEventListener('submit', (event) => {
            event.preventDefault()
            $('#cards').empty()
            fetchData(event.target)
        })
		
       
        fillDataList()
    })
	 const fillDataList = () => {
        let url = 'https://pomber.github.io/covid19/timeseries.json'
        let countryList = []
        fetch(url)
            .then(res => res.json())
            .then(res => {
                countryList = Object.keys(res)
                console.log(Object.keys(res), " Are all Countries being Tracked")
                localStorage.setItem('cList', JSON.stringify(countryList))
                countryList.forEach((cntry) => {
                    $('datalist').append(`<option value="${cntry}">`)
                })
            })
    }
	
	
	 const fetchData = async (target) => {

        let i = 1
        let longest = []
        let mainDB = {}
        let graphDB = []
        let dateLabels = {}
        let correctDate
        let type = $('#type').val()
        let typeData
        let url = 'https://pomber.github.io/covid19/timeseries.json'
        await fetch(url)
            .then(res => res.json())
            .then(res => {

                Array.from(target).forEach((elem) => {
                    if (elem.name == 'Country' && elem.value != '') {
                        country = elem.value
                        //      console.log("current country is ", country)
                        mainDB[country] = []
                        dateLabels[country] = []

                        res[country].forEach(({ date, confirmed, recovered, deaths }) => {

                            switch (type) {
                                case 'Confirmed': typeData = confirmed; break;
                                case 'Recovered': typeData = recovered; break;
                                case 'Deceased': typeData = deaths; break;
                            }

                            correctDate = formatDate(date)
                            mainDB[country].push({ x: correctDate, y: Number(typeData) })
                            dateLabels[country].push(correctDate)
                            latestConf = confirmed
                            latestReco = recovered
                            latestDead = deaths
                            latestDate = correctDate
                        })

                        $('#date').text('Data as of ' + latestDate)
                        createCard(country, latestConf, latestReco, latestDead)

                        if (dateLabels[country].length > longest.length) longest = [...dateLabels[country]]

                        console.log(mainDB[country], " is ", country)


                        switch (i) {
                            case 1: clr = 'rgb(255, 0, 0)'; break;
                            case 2: clr = 'rgb(0, 255, 0)'; break;
                            case 3: clr = 'rgb(0, 0, 255)'; break;
                            case 4: clr = 'rgb(232, 122, 199)'; break;
                            case 5: clr = 'rgb(60, 201, 215)'; break;
                        }
                        i++

                        let obj = {
                            label: country,
                            backgroundColor: clr,
                            borderColor: clr,
                            data: mainDB[country],
                            fill: false,
                            pointHoverBackgroundColor: 'rgb(0,0,0)',
                            pointHoverRadius: 6,
                        }

                        graphDB.push(obj)
                    }
                })
            })
            .catch((err) => {
                alert('Country name might be incorrect.')
            })
        drawGraph(graphDB, longest, type)

    }
	const drawGraph = (graphDB, longest, type) => {


        let config = {
            type: 'line',
            data: {
                labels: longest,
                datasets: graphDB,
            },
            options: {
                responsive: true,
                legend: {
                    labels: {
                        fontColor: 'white',
                        fontSize: 20,
                    }
                },
                title: {
                    display: false,
                    text: 'Covid 19 Cases'
                },
                tooltips: {
                    mode: 'x',
                    backgroundColor: 'rgb(0,128,0)',
                    //   	intersect: false,
                    titleFontSize: 18,
                    bodyFontSize: 17,
                },
                hover: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'series',
                        ticks: {
                            fontSize: 17,
                            fontColor: 'grey'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: type.toUpperCase() + '   CASES',
                            fontColor: 'white'
                        },
                        ticks: {
                            fontSize: 20,
                            fontColor: 'grey'
                        }
                    }]
                },
            }
        }
        $('canvas').remove()
        $('#chart-container').append('<canvas id="canvas"></canvas>')
        var ctx = document.getElementById('canvas').getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        window.myLine = new Chart(ctx, config);
    }
	 const createCard = (country, latestConf, latestReco, latestDead) => {
        $('#cards').append(`<div class="card">
        <div class="card-body">
		<h5 class="card-title">${country}</h5>
		<p class="mt-3 text-info"> Confirmed : ${latestConf}</p>
		<p class="text-success"> Recovered : ${latestReco}</p>
		<p class="text-danger"> Deaths : ${latestDead}</p>`)
    }

	const formatDate = (dateInWrongFormat) => {
        var len = dateInWrongFormat.length
        var lastPos = dateInWrongFormat.lastIndexOf('-')
        let day = dateInWrongFormat.slice(lastPos + 1)
        var firstPos = dateInWrongFormat.indexOf('-')
        let month = dateInWrongFormat.slice(firstPos + 1, lastPos)
        let year = dateInWrongFormat.substr(0, 4)
        //     console.log("year ",year," month ",month, " day ",day)
        return new Date(year, month - 1, day)
    }
</script>

</head>
<body>
<table id="haut">
<tr>
<td width="400px"><div class="date">1/11/2019 To <text id="date"> </div></td>
<td width="500px">

</td>
<td width="400px"><img src="logo.png" alt="logo corona" class="right"/></td>
</tr>
</table>
</br>
</br>
</br>
<table id="numb">
<tr>
<td width="800px">
<p id="new" class="title"> New Confirmed Cases Vs Deaths</p>
</td>
<td width="200px">
<div class=" cases">
<label> Cases</label>
<p class="output1"></p>
</div>
</td>

<td width="200px">

<div class="deaths">
<label > Deaths</label>
<p class="output2"></p>
</div>
</td>
<td width="200px">
<div class="recovered"
<label> Recovered</label>
<p class="output3"></p>
</div>
</td>
</tr>
</table>
<table id="all">
<tr>
<td>
 <div style="height:700px;weight:805px;overflow:auto;">
<table class="tab" border="2"  >
<thead>
      <tr>
	    
        <th>Countries</th>
		<th>Confirmed</th>
		<th>Deaths</th>
        <th>Recovred</th>
      </tr>
    </thead>
    <tbody class="mytable">
	
	 </tbody>
  </table>
  </div>
 </td>
 <td>
 
<h2>Choose a country then click </h2>
                    <form id="formulaire">
                        <div id="inputDiv">

                            <input type="text" name="Country"
                                placeholder="Choose Country Name" list="country">
                            <datalist id="country">

                            </datalist>

                        </div>
                        <div class="buttons">

                            <button type="submit" class="btn1">Show</button>
                           
                            <select class="btn2 " id="type">
                                <option value="Confirmed">Confirmed</option>
                                <option value="Recovered">Recovered</option>
                                <option value="Deceased">Deceased</option>
                            </select>

                        </div>
                    </form>
					 
                    <div id="cards">

                    </div>
 
 </td>
 <tr>
 <td>
 <p class="title"> Nunber Of Cases And Deaths In Each Country</p>
  <div id="piechart" style="width: 500px; height: 600px;"></div>
  
 </td>
  
 <td>
<p class="title"> Cumulative Confirmed Cases</p>
<div id="regions_div" style="width:900px; height:600px;"></div>

 
 </td>
 </tr>
 <tr>
 <td colspan="2">
 <p class="title"> Nunber Of Cases And Deaths In Each Country</p>
<div class="centrer" id="myChart2"  style="width=900px;height:500px"></div>
 
 </td>
 <tr>
 </table>
 

 <script>
   
   //le select
    var countries = $('#countries');
    var html='';
    $.getJSON("https://wuhan-coronavirus-api.laeyoung.endpoint.ainize.ai/jhu-edu/latest", function (data) {
    for (i = 0; i < data.length ; i++) {
        
        countries.append(
            $('<option></option>').html(data[i].countryregion)
        );
        
    }
    });
     //le total
	 $.getJSON("https://wuhan-coronavirus-api.laeyoung.endpoint.ainize.ai/jhu-edu/brief", function (data) {
    document.querySelector('.output1').textContent=data.confirmed;
	document.querySelector('.output2').textContent=data.deaths;
    document.querySelector('.output3').textContent=data.recovered;
	
    //console.log(data);

});

    
	//currents date
	n =  new Date();
    y = n.getFullYear();
    m = n.getMonth() + 1;
    d = n.getDate();
    document.getElementById("date").innerHTML = m + "/" + d + "/" + y;
</script>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>


<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-firestore.js"></script>
 <script>
 // Your web app's Firebase configuration
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyD5a0OWtuQmCceki9bOK-CAdG5hk41gHgo",
    authDomain: "mydocc19.firebaseapp.com",
    databaseURL: "https://mydocc19.firebaseio.com",
    projectId: "mydocc19",
    storageBucket: "mydocc19.appspot.com",
    messagingSenderId: "590596458684",
    appId: "1:590596458684:web:909d9c80996ac4e10928b9",
    measurementId: "G-1CEGJJ3S15"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  window.onload = function (){
	  var date = new Date();
	  var currentdate = date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear();
	  var firestore = firebase.firestore(); 
	   $.getJSON("https://wuhan-coronavirus-api.laeyoung.endpoint.ainize.ai/jhu-edu/latest", function (data) {
            var cont = [];
            var rec = [];
            var dea = [];
            var conf = [];
            var provin = [];
            var wal = [];
            for (var i = 0; i < data.length; i++) {
                cont[i] = 0;
                rec[i] = 0;
                conf[i] = 0;
                dea[i] = 0;
            }
            for (var i = 0; i < data.length; i++) {
                dea[i] = JSON.stringify(data[i].deaths);
                provin[i] = JSON.stringify(data[i].provincestate);
                rec[i] = JSON.stringify(data[i].recovered);
                conf[i] = JSON.stringify(data[i].confirmed);
                cont[i] = JSON.stringify(data[i].countryregion);
            }
            for (var i = 0; i < data.length; i++) {
                if (dea[i] === undefined) {
                    dea[i] = "0";
                }
                else {
                    dea[i] = JSON.stringify(data[i].deaths);
                }
            }
            for (var i = 0; i < data.length; i++) {
                if (rec[i] === undefined) {
                    rec[i] = "0";
                }
                else {
                    rec[i] = JSON.stringify(data[i].recovered);
                }
            }
            for (var i = 0; i < data.length; i++) {
                if (conf[i] === undefined) {
                    conf[i] = "0";
                }
                else {
                    conf[i] = JSON.stringify(data[i].confirmed);
                }
            }
	   
	   
            for (var i = 0; i < data.length; i++) {
                var docVar = firestore.doc(currentdate + "/" + cont[i]);
                docVar.set({
                    Province_State: provin[i],
                    Confirmed_Cases: conf[i],
                    Deaths: dea[i],
                    Recovered: rec[i],


                })
            }
			
			
        })
    };
	
 //pour remplir le tableau
	
	window.onload=function(){
	$.getJSON("https://wuhan-coronavirus-api.laeyoung.endpoint.ainize.ai/jhu-edu/latest", function (data) {
    
    for(var i =0; i < data.length; i++) { 
        
        html += "<tr>";
        html += "<td>"+data[i].countryregion+"</td>";
        html += "<td>"+data[i].confirmed+"</td>";
        html += "<td>"+data[i].deaths+"</td>";
        html += "<td>"+data[i].recovered+"</td>";
        html += "</tr>";

        $('.mytable').append(html);
        html = "";
    }
	});
	}
	</script>
	

</body>
</html>
